# Design: Formalize GitHub Copilot API Requirements

## Context

CLIProxyAPI å½“å‰å®ç°å¯¹ GitHub Copilot çš„æ”¯æŒå­˜åœ¨å¤šä¸ªä¸å®˜æ–¹ API è§„èŒƒä¸ç¬¦çš„é—®é¢˜ï¼Œå…¶ä¸­æœ€ä¸¥é‡çš„æ˜¯å¼ºåˆ¶è®¾ç½® `stream=false` å¯¼è‡´æ‰€æœ‰è¯·æ±‚å¤±è´¥ã€‚æœ¬æ¬¡è®¾è®¡æ—¨åœ¨è§„èŒƒåŒ– Copilot é›†æˆï¼Œç¡®ä¿ç¬¦åˆå®˜æ–¹è¦æ±‚ã€‚

## Design Decisions

### 1. å¤ç”¨ Codex Executor vs åˆ›å»ºç‹¬ç«‹ Copilot Executor

**å†³ç­–**: ä¿æŒå¤ç”¨ CodexExecutorï¼Œé€šè¿‡ `identifier="copilot"` åŒºåˆ†

**ç†ç”±**:
- âœ… æœ€å°åŒ–ä»£ç å˜æ›´ï¼Œé™ä½é£é™©
- âœ… Copilot ä¸ Codex å…±äº«å¤§éƒ¨åˆ† HTTP å®¢æˆ·ç«¯é€»è¾‘ï¼ˆä»£ç†ã€è¶…æ—¶ã€è¯·æ±‚å¤´ï¼‰
- âœ… é€šè¿‡ `if e.Identifier() == "copilot"` æ¡ä»¶åˆ†æ”¯å·²å®ç°å·®å¼‚åŒ–å¤„ç†
- âš ï¸ ç¼ºç‚¹ï¼šç«¯ç‚¹é€»è¾‘æ··åˆåœ¨åŒä¸€æ‰§è¡Œå™¨ä¸­ï¼Œå¯è¯»æ€§ç•¥é™

**æ›¿ä»£æ–¹æ¡ˆè€ƒè™‘**:
- åˆ›å»º `CopilotChatExecutor`: ä¼˜ç‚¹æ˜¯æ¸…æ™°åˆ†ç¦»ï¼Œç¼ºç‚¹æ˜¯ä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜

**æœªæ¥ä¼˜åŒ–è·¯å¾„**:
- å¦‚æœ Copilot å·®å¼‚åŒ–éœ€æ±‚å¢åŠ ï¼ˆå¦‚ç‰¹æ®Šé‡è¯•ç­–ç•¥ã€ä¸åŒè®¤è¯æ–¹å¼ï¼‰ï¼Œå¯é‡æ„ä¸ºç‹¬ç«‹æ‰§è¡Œå™¨

---

### 2. æµå¼å“åº”å¼ºåˆ¶ç­–ç•¥

**å†³ç­–**: å¼ºåˆ¶è®¾ç½® `stream=true`ï¼Œç§»é™¤ `stream=false` è¦†ç›–

**ç†ç”±**:
- âœ… Copilot chat/completions ç«¯ç‚¹æ˜ç¡®æ‹’ç» `stream=false`ï¼ˆ400 Bad Requestï¼‰
- âœ… æ—¥å¿—è¯æ®æ˜¾ç¤ºå½“å‰å®ç°å¯¼è‡´æ‰€æœ‰è¯·æ±‚å¤±è´¥
- âœ… ä¿®æ”¹ç®€å•ï¼Œé£é™©ä½ï¼ˆä»…ä¿®æ”¹ 1 è¡Œä»£ç ï¼‰

**å®ç°ä½ç½®**:
```go
// internal/runtime/executor/codex_executor.go:88
// æ—§: body, _ = sjson.SetBytes(body, "stream", false)
// æ–°: body, _ = sjson.SetBytes(body, "stream", true)
```

**å½±å“åˆ†æ**:
- ç°æœ‰ç”¨æˆ·: æ— å½±å“ï¼ˆå½“å‰å®ç°æœ¬èº«å°±å¤±è´¥ï¼‰
- æ–°ç”¨æˆ·: æ­£å¸¸å·¥ä½œ
- å‘åå…¼å®¹æ€§: å®Œå…¨å…¼å®¹

---

### 3. ç«¯ç‚¹é€‰æ‹©ä¼˜å…ˆçº§è®¾è®¡

**å†³ç­–**: å››çº§ä¼˜å…ˆçº§é“¾ï¼Œæ”¯æŒçµæ´»é…ç½®å’Œ token è‡ªåŠ¨æ´¾ç”Ÿ

**ä¼˜å…ˆçº§**:
1. `auth.Attributes["base_url"]` - ç”¨æˆ·æ˜¾å¼é…ç½®
2. `auth.Metadata["base_url"]` - å…ƒæ•°æ®è¦†ç›–
3. Token æ´¾ç”Ÿ `proxy-ep=<host>` - è‡ªåŠ¨æ£€æµ‹
4. é»˜è®¤ `https://api.githubcopilot.com` - å®˜æ–¹ç«¯ç‚¹

**ç†ç”±**:
- âœ… æ”¯æŒä¼ä¸šè‡ªå»ºä»£ç†ï¼ˆä¼˜å…ˆçº§ 1ï¼‰
- âœ… æ”¯æŒåŠ¨æ€é…ç½®ï¼ˆä¼˜å…ˆçº§ 2ï¼‰
- âœ… æ”¯æŒä¸ªäºº Copilot tokenï¼ˆä¼˜å…ˆçº§ 3ï¼Œå¸¸è§æ ¼å¼ï¼‰
- âœ… æä¾›ç¨³å®šåå¤‡ï¼ˆä¼˜å…ˆçº§ 4ï¼‰

**ç«¯ç‚¹è·¯å¾„å¤„ç†**:
- âŒ æ‹’ç» `/backend-api/codex` åç¼€ï¼ˆCodex Responses API ä¸“ç”¨ï¼‰
- âœ… ç»Ÿä¸€ä½¿ç”¨ `/chat/completions` ç«¯ç‚¹ï¼ˆCopilot Chat APIï¼‰

**å®ç°ç»†èŠ‚**:
```go
// service.go:199-205 - æ¸…ç†æ— æ•ˆè·¯å¾„
if strings.HasSuffix(strings.TrimRight(raw, "/"), "/backend-api/codex") {
    delete(auth.Attributes, "base_url")  // å¼ºåˆ¶å›é€€åˆ°é»˜è®¤æˆ– token æ´¾ç”Ÿ
}

// codex_executor.go:65-85 - ç«¯ç‚¹é€‰æ‹©
candidate := attributes.base_url || metadata.base_url || deriveCopilotBaseFromToken(token)
if candidate == "" { candidate = "https://api.githubcopilot.com" }
url := strings.TrimSuffix(candidate, "/") + "/chat/completions"
```

---

### 4. è®¤è¯æµç¨‹è®¾è®¡ï¼ˆåŒå±‚ OAuthï¼‰

**å†³ç­–**: ä¿æŒç°æœ‰ GitHub Device Flow + Copilot Token Exchange æ¶æ„

**æµç¨‹**:
```
ç”¨æˆ·è§¦å‘ --copilot-auth-login
  â†“
POST github.com/login/device/code
  â†“
æ˜¾ç¤º user_codeï¼Œæ‰“å¼€æµè§ˆå™¨
  â†“
è½®è¯¢ github.com/login/oauth/access_token
  â†“
è·å– github_access_token
  â†“
GET api.github.com/copilot_internal/v2/token
  â†“
è·å– copilot access_token + refresh_in
  â†“
æŒä¹…åŒ–åˆ° JSON æ–‡ä»¶
```

**å­˜å‚¨ç»“æ„**:
```json
{
  "access_token": "<copilot_token>",
  "github_access_token": "<github_token>",
  "expires_at": 1234567890,
  "refresh_in": 28800
}
```

**Token åˆ·æ–°ç­–ç•¥**:
- åŸºäº `refresh_in` å­—æ®µï¼ˆé€šå¸¸ 8 å°æ—¶ï¼‰
- å®‰å…¨è¾¹é™…ï¼š`RefreshSafetyMarginSeconds = 60` ç§’
- è§¦å‘æ—¶æœºï¼š`current_time >= last_refresh + (refresh_in - 60)`

**ç†ç”±**:
- âœ… ç¬¦åˆ GitHub å®˜æ–¹è®¤è¯è§„èŒƒ
- âœ… æ”¯æŒé•¿æœŸ sessionï¼ˆé€šè¿‡ refresh_in é¢„åˆ·æ–°ï¼‰
- âœ… æ— éœ€ç”¨æˆ·é‡å¤æˆæƒ

---

### 5. è¯·æ±‚å¤´æ ‡å‡†åŒ–

**å†³ç­–**: å¼ºåˆ¶åŒ…å«æ‰€æœ‰å¿…éœ€çš„ HTTP è¯·æ±‚å¤´

**å¿…éœ€å¤´éƒ¨**:
```go
Authorization: Bearer <access_token>
Content-Type: application/json
Accept: text/event-stream          // æµå¼
user-agent: GitHubCopilotChat/0.26.7
editor-version: vscode/1.0
editor-plugin-version: copilot-chat/0.26.7
openai-intent: conversation-panel
x-github-api-version: 2025-04-01
x-request-id: <UUID>
```

**ç†ç”±**:
- âœ… ç¬¦åˆå®˜æ–¹å®¢æˆ·ç«¯è¡Œä¸ºï¼ˆé€šè¿‡é€†å‘åˆ†æ VS Code æ‰©å±•ï¼‰
- âœ… é¿å…è®¤è¯å¤±è´¥æˆ–åè®®é”™è¯¯
- âœ… æä¾›å¯è¿½è¸ªçš„è¯·æ±‚ ID

**ç‰ˆæœ¬ç­–ç•¥**:
- ç¡¬ç¼–ç ç‰ˆæœ¬å·ï¼ˆ`GitHubCopilotChat/0.26.7`ï¼‰
- å¯é…ç½®åŒ–ï¼ˆåç»­ä¼˜åŒ–ï¼Œå¦‚ GitHub æ›´æ–°è¦æ±‚ï¼‰

---

### 6. é”™è¯¯å¤„ç†ç­–ç•¥

**å†³ç­–**: ç»Ÿä¸€ä½¿ç”¨ `statusErr{code, msg}` åŒ…è£…å™¨ï¼ŒåŸæ ·ä¼ é€’ä¸Šæ¸¸é”™è¯¯

**é”™è¯¯æ˜ å°„**:
| çŠ¶æ€ç  | å¤„ç†æ–¹å¼ | é‡è¯•ç­–ç•¥ |
|--------|---------|---------|
| 400 | è¿”å›åŸå§‹é”™è¯¯æ¶ˆæ¯ | ä¸é‡è¯•ï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰ |
| 401 | è¿”å› "Invalid API key" | è§¦å‘ token åˆ·æ–°ï¼ˆå¦‚å¯ç”¨ï¼‰ |
| 429 | è¿”å›åŸå§‹é”™è¯¯æ¶ˆæ¯ | ä¸é‡è¯•ï¼ˆäº¤ç”±å®¢æˆ·ç«¯å¤„ç†ï¼‰ |
| 500 | è¿”å›åŸå§‹é”™è¯¯æ¶ˆæ¯ | ä¸é‡è¯•ï¼ˆä¸Šæ¸¸é—®é¢˜ï¼‰ |

**ç†ç”±**:
- âœ… ä¿æŒä¸€è‡´æ€§ï¼ˆæ‰€æœ‰ executor ç»Ÿä¸€è¡Œä¸ºï¼‰
- âœ… ä¿ç•™ä¸Šæ¸¸é”™è¯¯è¯¦æƒ…ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- âœ… é¿å…è¿‡åº¦å°è£…ï¼ˆé€æ˜ä¼ é€’é”™è¯¯ï¼‰

**ç‰¹æ®Šå¤„ç†**:
- æµä¸­æ–­: `408 Timeout` + "stream disconnected before completion"
- è®¤è¯å¤±è´¥: å¯é€‰è§¦å‘ token åˆ·æ–°ï¼ˆå½“å‰æœªå®ç°ï¼Œåç»­ä¼˜åŒ–ï¼‰

---

### 7. æ¨¡å‹æ¸…å•ç®¡ç†

**å†³ç­–**: Copilot æ¨¡å‹ç‹¬ç«‹äº OpenAI/Codexï¼Œä½¿ç”¨ seed é¢„æ³¨å†Œæœºåˆ¶

**æ¨¡å‹åˆ—è¡¨**:
- `gpt-5-mini`
- `grok-code-fast-1`

**Seed æ³¨å†Œæµç¨‹**:
```
æœåŠ¡å¯åŠ¨
  â†“
ensureCopilotModelsRegistered()
  â†“
GlobalModelRegistry().Register(
  clientID: "copilot:models:seed",
  models: [gpt-5-mini, grok-code-fast-1]
)
  â†“
ç”¨æˆ·æ·»åŠ  Copilot auth
  â†“
applyCoreAuthAddOrUpdate()
  â†“
GlobalModelRegistry().UnregisterClient("copilot:models:seed")
GlobalModelRegistry().Register(
  clientID: auth.ID,
  models: [gpt-5-mini, grok-code-fast-1]
)
```

**ç†ç”±**:
- âœ… æœªæˆæƒæ—¶ä¹Ÿèƒ½å±•ç¤º Copilot æ¨¡å‹ï¼ˆ`/v1/models` å¯è§ï¼‰
- âœ… æˆæƒåè‡ªåŠ¨å…³è”åˆ°çœŸå® auth ID
- âœ… é¿å…ä¸ OpenAI æ¨¡å‹æ··æ·†

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client Request                            â”‚
â”‚  POST /v1/chat/completions                                       â”‚
â”‚  Authorization: Bearer <copilot_token>                           â”‚
â”‚  Body: {"model": "gpt-5-mini", "messages": [...]}                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AuthMiddleware                                â”‚
â”‚  - Extract Bearer token                                          â”‚
â”‚  - Match to provider="copilot"                                   â”‚
â”‚  - Set context: apiKey, accessProvider                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Route to OpenAI Handler                       â”‚
â”‚  /v1/chat/completions â†’ openaiHandlers.ChatCompletions          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Core Auth Manager                               â”‚
â”‚  pickNext(provider="copilot", model="gpt-5-mini")                â”‚
â”‚  â†’ è¿”å› Auth{Provider: copilot, Metadata: {access_token, ...}}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CodexExecutor (Copilot Branch)                   â”‚
â”‚  if e.Identifier() == "copilot" {                                â”‚
â”‚    1. Endpoint Selection (4-tier priority)                       â”‚
â”‚    2. Set stream=true                                            â”‚
â”‚    3. Add Copilot headers                                        â”‚
â”‚    4. ExecuteStream() â†’ SSE handling                             â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Upstream Copilot API                                â”‚
â”‚  POST https://api.githubcopilot.com/chat/completions             â”‚
â”‚  Headers: Authorization, user-agent, x-github-api-version, ...   â”‚
â”‚  Body: {"model": "gpt-5-mini", "stream": true, ...}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SSE Response Stream                           â”‚
â”‚  event: message_start                                            â”‚
â”‚  data: {"type": "message_start", ...}                            â”‚
â”‚                                                                  â”‚
â”‚  event: content_block_delta                                      â”‚
â”‚  data: {"type": "delta", "delta": {"text": "Hello"}}            â”‚
â”‚                                                                  â”‚
â”‚  data: [DONE]                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SSE Parsing & Translation                          â”‚
â”‚  bufio.Scanner â†’ jsonPayload() â†’ TranslateStream()               â”‚
â”‚  â†’ è½¬æ¢ä¸º OpenAI æ ¼å¼ï¼ˆå¦‚éœ€è¦ï¼‰â†’ è¿”å›å®¢æˆ·ç«¯                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Trade-offs and Alternatives

### Trade-off 1: Stream=true å¼ºåˆ¶ vs å‚æ•°é€ä¼ 
- **é€‰æ‹©**: å¼ºåˆ¶ stream=true
- **æ›¿ä»£**: é€ä¼ å®¢æˆ·ç«¯å‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› 400
- **ç†ç”±**: é¿å…ç”¨æˆ·å›°æƒ‘ï¼Œç¡®ä¿ Copilot è¯·æ±‚å§‹ç»ˆæˆåŠŸ

### Trade-off 2: å¤ç”¨ Codex Executor vs ç‹¬ç«‹æ‰§è¡Œå™¨
- **é€‰æ‹©**: å¤ç”¨
- **æ›¿ä»£**: åˆ›å»º CopilotChatExecutor
- **ç†ç”±**: å‡å°‘ä»£ç é‡å¤ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ï¼ˆå½“å‰å·®å¼‚åŒ–éœ€æ±‚å°‘ï¼‰

### Trade-off 3: ç«¯ç‚¹ç¡¬ç¼–ç  vs å…¨é…ç½®åŒ–
- **é€‰æ‹©**: é»˜è®¤ç¡¬ç¼–ç  + é…ç½®è¦†ç›–
- **æ›¿ä»£**: å…¨éƒ¨ä»é…ç½®è¯»å–
- **ç†ç”±**: é™ä½é…ç½®å¤æ‚åº¦ï¼Œå¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨é»˜è®¤å€¼

---

## Security Considerations

### Token å­˜å‚¨
- âœ… JSON æ–‡ä»¶æƒé™ï¼šä»…å½“å‰ç”¨æˆ·å¯è¯»å†™ï¼ˆ0600ï¼‰
- âš ï¸ æ—¥å¿—é®è”½ï¼šå½“å‰ä»…é®è”½ Authorization headerï¼Œæœªé®è”½ metadata.access_token
- ğŸ”œ æ”¹è¿›ï¼šæ‰©å±• maskAuthorizationHeader åˆ° metadata å­—æ®µ

### HTTPS å¼ºåˆ¶
- âœ… æ‰€æœ‰ Copilot API è°ƒç”¨ä½¿ç”¨ HTTPS
- âœ… Token æ´¾ç”Ÿé€»è¾‘è‡ªåŠ¨æ·»åŠ  `https://` å‰ç¼€

### è®¤è¯ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸ
- âœ… é¢„åˆ·æ–°æœºåˆ¶é¿å…è¿‡æœŸ token ä½¿ç”¨
- âœ… å®‰å…¨è¾¹é™…ï¼ˆ60 ç§’ï¼‰é˜²æ­¢è¾¹ç•Œæƒ…å†µ

---

## Migration Path

### ä»å½“å‰å®ç°è¿ç§»
1. **æ— é…ç½®å˜æ›´**: ç”¨æˆ·æ— éœ€ä¿®æ”¹ YAML
2. **æ— æ•°æ®è¿ç§»**: ç°æœ‰ auth JSON æ–‡ä»¶å®Œå…¨å…¼å®¹
3. **è¡Œä¸ºå˜æ›´**: ä»å¤±è´¥ï¼ˆ400ï¼‰â†’ æˆåŠŸï¼ˆ200ï¼‰ï¼Œçº¯æ”¹è¿›

### å‘åå…¼å®¹æ€§
- âœ… é…ç½®æ–‡ä»¶æ ¼å¼ä¸å˜
- âœ… API æ¥å£ä¸å˜
- âœ… è®¤è¯æµç¨‹ä¸å˜
- âœ… æ—¥å¿—æ ¼å¼ä¸å˜ï¼ˆä»…å†…å®¹å˜åŒ–ï¼šstream=trueï¼‰

---

## Testing Strategy

### å•å…ƒæµ‹è¯•
- [ ] `deriveCopilotBaseFromToken()` - å„ç§ token æ ¼å¼
- [ ] `shouldRefresh()` - åˆ·æ–°æ—¶æœºè®¡ç®—
- [ ] `sanitizeCopilotOAuth()` - é…ç½®é»˜è®¤å€¼

### é›†æˆæµ‹è¯•
- [ ] OAuth Device Flow - Mock GitHub API
- [ ] Token åˆ·æ–° - Mock GitHub API
- [ ] ç«¯ç‚¹é€‰æ‹© - å„ä¼˜å…ˆçº§åœºæ™¯

### E2E æµ‹è¯•
- [ ] Chat/completions è¯·æ±‚ - Mock Copilot API
- [ ] SSE æµå¼å“åº” - å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- [ ] é”™è¯¯å¤„ç† - å„ HTTP çŠ¶æ€ç 

---

## Performance Considerations

### Token åˆ·æ–°æ€§èƒ½
- **é¢‘ç‡**: æ¯ 8 å°æ—¶ 1 æ¬¡
- **å½±å“**: å¯å¿½ç•¥ï¼ˆå•æ¬¡ HTTP è¯·æ±‚ï¼‰
- **ä¼˜åŒ–**: å¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡è¯·æ±‚

### SSE ç¼“å†²åŒº
- **å¤§å°**: 20MB (`bufio.Scanner` ç¼“å†²)
- **å½±å“**: æ”¯æŒå¤§æ¨¡å‹å“åº”ï¼Œå†…å­˜å ç”¨åˆç†

---

## Future Enhancements

1. **ç‹¬ç«‹ Copilot æ‰§è¡Œå™¨**: å¦‚å·®å¼‚åŒ–éœ€æ±‚å¢åŠ ï¼Œé‡æ„ä¸ºç‹¬ç«‹ç»„ä»¶
2. **å‚æ•°éªŒè¯å‘Šè­¦**: å¯¹ä¸æ”¯æŒå‚æ•°å‘å‡ºè­¦å‘Šï¼ˆå¦‚ `logprobs`ï¼‰
3. **æ—¥å¿—é®è”½å¢å¼º**: æ‰©å±•åˆ° metadata æ•æ„Ÿå­—æ®µ
4. **Token æ ¼å¼éªŒè¯**: æ£€æŸ¥ `sk-*` å‰ç¼€ï¼ŒåŒºåˆ† Copilot vs OpenAI token
5. **é…ç½®åŒ– User-Agent**: æ”¯æŒè‡ªå®šä¹‰ç‰ˆæœ¬å·ï¼ˆå¦‚ GitHub æ›´æ–°è¦æ±‚ï¼‰
6. **é‡è¯•ç­–ç•¥**: 401 é”™è¯¯æ—¶è‡ªåŠ¨è§¦å‘ token åˆ·æ–°å¹¶é‡è¯•

---

## References

- GitHub Copilot CLI æ¶æ„åˆ†æ: https://medium.com/@shubh7/github-copilot-cli-architecture-features-and-operational-protocols-f230b8b3789f
- GitHub Device Flow OAuth: https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#device-flow
- SSE è§„èŒƒ: https://html.spec.whatwg.org/multipage/server-sent-events.html
- CLIProxyAPI ç°æœ‰å®ç°: `internal/runtime/executor/codex_executor.go`, `sdk/cliproxy/auth/manager.go`
