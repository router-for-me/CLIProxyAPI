import{_ as i,o as t,c as s,ag as a}from"./chunks/framework.DM0yugQT.js";const u=JSON.parse('{"title":"Distributed FS/Compute Status","description":"","frontmatter":{},"headers":[],"relativePath":"operations/distributed-fs-compute-status.md","filePath":"operations/distributed-fs-compute-status.md","lastUpdated":1771758548000}'),o={name:"operations/distributed-fs-compute-status.md"};function n(l,e,d,r,p,c){return t(),s("div",null,[...e[0]||(e[0]=[a(`<h1 id="distributed-fs-compute-status" tabindex="-1">Distributed FS/Compute Status <a class="header-anchor" href="#distributed-fs-compute-status" aria-label="Permalink to &quot;Distributed FS/Compute Status&quot;">​</a></h1><p>Last reviewed: <code>2026-02-21</code><br> Scope: current implementation status for distributed-ish auth storage, file-sync, and runtime compute control paths.</p><h2 id="status-matrix" tabindex="-1">Status Matrix <a class="header-anchor" href="#status-matrix" aria-label="Permalink to &quot;Status Matrix&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Track</th><th>Status</th><th>Evidence (current code/docs)</th><th>Notes</th></tr></thead><tbody><tr><td>Auth/config persistence backends (Postgres/Object/Git/File)</td><td>Implemented</td><td><code>cmd/server/main.go:226</code>, <code>cmd/server/main.go:259</code>, <code>cmd/server/main.go:292</code>, <code>cmd/server/main.go:361</code>, <code>cmd/server/main.go:393</code>, <code>cmd/server/main.go:497</code></td><td>Runtime can boot from multiple storage backends and register a shared token store.</td></tr><tr><td>Local file-change ingestion (config + auth dir)</td><td>Implemented</td><td><code>pkg/llmproxy/watcher/watcher.go:88</code>, <code>pkg/llmproxy/watcher/events.go:36</code>, <code>pkg/llmproxy/watcher/events.go:42</code>, <code>pkg/llmproxy/watcher/events.go:77</code></td><td>Uses <code>fsnotify</code>; this is node-local watching, not a distributed event system.</td></tr><tr><td>Auth update compute queue + burst drain</td><td>Implemented</td><td><code>sdk/cliproxy/service.go:130</code>, <code>sdk/cliproxy/service.go:137</code>, <code>sdk/cliproxy/service.go:140</code>, <code>sdk/cliproxy/service.go:154</code>, <code>sdk/cliproxy/service.go:640</code></td><td>Queue depth fixed at 256; drains backlog in tight loop.</td></tr><tr><td>Runtime compute attachment via websocket provider sessions</td><td>Implemented</td><td><code>sdk/cliproxy/service.go:535</code>, <code>sdk/cliproxy/service.go:537</code>, <code>sdk/cliproxy/service.go:230</code></td><td>Websocket channels can add/remove runtime auths dynamically.</td></tr><tr><td>Periodic auth refresh worker in core runtime</td><td>Implemented</td><td><code>sdk/cliproxy/service.go:666</code></td><td>Core manager auto-refresh starts at 15m interval.</td></tr><tr><td>Provider metrics surface for ops dashboards</td><td>Implemented</td><td><code>pkg/llmproxy/api/server.go:370</code></td><td><code>/v1/metrics/providers</code> is live and should be treated as current operational surface.</td></tr><tr><td>Cooldown/recovery control plane endpoints (<code>/v0/operations/*</code>)</td><td>In Progress</td><td><code>docs/features/operations/USER.md:720</code>, <code>docs/features/operations/USER.md:725</code>, <code>docs/features/operations/USER.md:740</code>; route reality: <code>pkg/llmproxy/api/server.go:331</code>, <code>pkg/llmproxy/api/server.go:518</code></td><td>Docs/spec describe endpoints, but runtime only exposes <code>/v1</code> and <code>/v0/management</code> groups today.</td></tr><tr><td>Liveness endpoint (<code>/health</code>) contract</td><td>Blocked</td><td><code>docs/api/operations.md:12</code>, <code>docs/features/operations/USER.md:710</code>; no matching route registration in <code>pkg/llmproxy/api/server.go</code></td><td>Ops docs and runtime are currently out of sync on health probe path.</td></tr><tr><td>Distributed multi-node state propagation (cross-node auth event bus)</td><td>Blocked</td><td>local watcher model in <code>pkg/llmproxy/watcher/events.go:36</code>, <code>pkg/llmproxy/watcher/events.go:42</code>; queue wiring in <code>sdk/cliproxy/service.go:640</code></td><td>Current flow is single-node event ingestion + local queue handling.</td></tr><tr><td>Generic operations API for cooldown status/provider status/load-balancing status</td><td>Blocked</td><td>docs claims in <code>docs/features/operations/USER.md:720</code>, <code>docs/features/operations/USER.md:725</code>, <code>docs/features/operations/USER.md:740</code>; runtime routes in <code>pkg/llmproxy/api/server.go:331</code>, <code>pkg/llmproxy/api/server.go:518</code></td><td>No concrete handler registration found for <code>/v0/operations/...</code> paths.</td></tr></tbody></table><h2 id="architecture-map-current" tabindex="-1">Architecture Map (Current) <a class="header-anchor" href="#architecture-map-current" aria-label="Permalink to &quot;Architecture Map (Current)&quot;">​</a></h2><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Storage Backends (FS/Git/Postgres/Object)</span></span>
<span class="line"><span>  -&gt; token store registration (cmd/server/main.go)</span></span>
<span class="line"><span>  -&gt; core auth manager load (sdk/cliproxy/service.go)</span></span>
<span class="line"><span>  -&gt; watcher fsnotify loop (pkg/llmproxy/watcher/events.go)</span></span>
<span class="line"><span>  -&gt; auth update queue (sdk/cliproxy/service.go, buffered 256)</span></span>
<span class="line"><span>  -&gt; auth apply/update + model registration (sdk/cliproxy/service.go)</span></span>
<span class="line"><span>  -&gt; API server routes (/v1/* + /v0/management/* + /v1/metrics/providers)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Parallel runtime path:</span></span>
<span class="line"><span>Websocket gateway (/v1/ws and /v1/responses)</span></span>
<span class="line"><span>  -&gt; runtime auth add/remove events</span></span>
<span class="line"><span>  -&gt; same auth queue/apply pipeline</span></span></code></pre></div><p>Key boundary today:</p><ul><li>Distributed storage backends exist.</li><li>Distributed coordination plane does not (no cross-node watcher/event bus contract in runtime paths yet).</li></ul><h2 id="next-10-actionable-items" tabindex="-1">Next 10 Actionable Items <a class="header-anchor" href="#next-10-actionable-items" aria-label="Permalink to &quot;Next 10 Actionable Items&quot;">​</a></h2><ol><li>Add a real <code>GET /health</code> route in <code>setupRoutes</code> and return dependency-aware status (<code>pkg/llmproxy/api/server.go</code>).</li><li>Introduce <code>/v0/operations/providers/status</code> handler backed by core auth + registry/runtime provider state (<code>sdk/cliproxy/service.go</code>, <code>pkg/llmproxy/api/server.go</code>).</li><li>Expose cooldown snapshot endpoint by wrapping existing Kiro cooldown manager state (<code>pkg/llmproxy/auth/kiro/cooldown.go</code>, <code>pkg/llmproxy/runtime/executor/kiro_executor.go</code>).</li><li>Add <code>/v0/operations/load_balancing/status</code> using current selector/routing strategy already switched in reload callback (<code>sdk/cliproxy/service.go</code>).</li><li>Emit queue depth/drain counters for <code>authUpdates</code> to make backpressure visible (<code>sdk/cliproxy/service.go:130</code>, <code>sdk/cliproxy/service.go:154</code>).</li><li>Add API tests asserting presence/response shape for <code>/health</code> and <code>/v0/operations/*</code> once implemented (<code>pkg/llmproxy/api</code> test suite).</li><li>Define a node identity + backend mode payload (file/git/postgres/object) for ops introspection using startup configuration paths (<code>cmd/server/main.go</code>).</li><li>Add an optional cross-node event transport (Postgres <code>LISTEN/NOTIFY</code>) so non-local auth mutations can propagate without filesystem coupling. See <a href="#actionable-item-8-design-prep-postgres-listennotify">Actionable Item 8 Design Prep</a>.</li><li>Reconcile docs with runtime in one pass: update <code>docs/features/operations/USER.md</code> and <code>docs/api/operations.md</code> to only list implemented endpoints until new handlers ship.</li><li>Extend <code>docs/operations/critical-endpoints-curl-pack.md</code> with the new canonical health + operations endpoints after implementation, and deprecate stale probes.</li></ol><h2 id="actionable-item-8-design-prep-postgres-listen-notify" tabindex="-1">Actionable Item 8 Design Prep (Postgres LISTEN/NOTIFY) <a class="header-anchor" href="#actionable-item-8-design-prep-postgres-listen-notify" aria-label="Permalink to &quot;Actionable Item 8 Design Prep (Postgres LISTEN/NOTIFY)&quot;">​</a></h2><p>Goal: propagate auth/config mutation events across nodes without changing existing local watcher semantics.</p><p>Design constraints:</p><ul><li>Non-breaking: current single-node fsnotify + local queue path remains default.</li><li>Optional transport: only enabled when a Postgres DSN and feature flag are set.</li><li>At-least-once delivery semantics with idempotent consumer behavior.</li><li>No cross-node hard dependency for startup; service must run if transport is disabled.</li></ul><h3 id="proposed-transport-shape" tabindex="-1">Proposed Transport Shape <a class="header-anchor" href="#proposed-transport-shape" aria-label="Permalink to &quot;Proposed Transport Shape&quot;">​</a></h3><p>Channel:</p><ul><li><code>cliproxy_auth_events_v1</code></li></ul><p>Emit path (future runtime implementation):</p><ul><li>On successful local auth/config mutation apply, issue <code>NOTIFY cliproxy_auth_events_v1, &#39;&lt;json-payload&gt;&#39;</code>.</li><li>Local origin node should still process its own queue directly (no dependency on loopback notify).</li></ul><p>Receive path (future runtime implementation):</p><ul><li>Dedicated listener connection executes <code>LISTEN cliproxy_auth_events_v1</code>.</li><li>Each received payload is validated, deduped, and enqueued onto existing <code>authUpdates</code> path.</li></ul><h3 id="payload-schema-json" tabindex="-1">Payload Schema (JSON) <a class="header-anchor" href="#payload-schema-json" aria-label="Permalink to &quot;Payload Schema (JSON)&quot;">​</a></h3><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;schema_version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;01JZ9Y2SM9BZXW4KQY4R6X8J6W&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event_type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;auth.upsert&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;occurred_at&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2026-02-21T08:30:00Z&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;origin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;node_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;node-a-01&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;instance_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pod/cliproxy-7f6f4db96b-w2x9d&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;backend_mode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;postgres&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;subject&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;auth_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;openai-default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;provider&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;openai&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;tenant_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;default&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;mutation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;revision&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;kind&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;upsert&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;reason&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;api_write&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;correlation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;request_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;req_123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;actor&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;operations-api&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Field notes:</p><ul><li><code>event_id</code>: ULID/UUID for dedupe.</li><li><code>event_type</code>: enum candidate set: <code>auth.upsert</code>, <code>auth.delete</code>, <code>config.reload</code>.</li><li><code>mutation.revision</code>: monotonically increasing per <code>auth_id</code> if available; otherwise omitted and dedupe uses <code>event_id</code>.</li><li><code>origin.node_id</code>: stable node identity from startup config.</li></ul><h3 id="failure-modes-and-handling" tabindex="-1">Failure Modes and Handling <a class="header-anchor" href="#failure-modes-and-handling" aria-label="Permalink to &quot;Failure Modes and Handling&quot;">​</a></h3><ol><li>Notify payload dropped or listener disconnect:</li></ol><ul><li>Risk: missed event on one or more nodes.</li><li>Handling: periodic reconciliation poll (<code>N</code> minutes) compares latest auth/config revision and self-heals drift.</li></ul><ol start="2"><li>Duplicate delivery (at-least-once):</li></ol><ul><li>Risk: repeated apply work.</li><li>Handling: dedupe cache keyed by <code>event_id</code> (TTL 10-30m) before enqueue.</li></ul><ol start="3"><li>Out-of-order events:</li></ol><ul><li>Risk: stale mutation applied after newer one.</li><li>Handling: if <code>mutation.revision</code> exists, ignore stale revisions per <code>auth_id</code>; otherwise rely on timestamp guard plus eventual reconcile.</li></ul><ol start="4"><li>Oversized payload (&gt; Postgres NOTIFY payload limit):</li></ol><ul><li>Risk: event reject/truncation.</li><li>Handling: keep payload metadata-only; never include secrets/token material; fetch full state from source-of-truth store on consume.</li></ul><ol start="5"><li>Channel flood/backpressure:</li></ol><ul><li>Risk: queue saturation and delayed apply.</li><li>Handling: preserve current bounded queue; add drop/lag metrics and alert thresholds before turning feature on by default.</li></ul><ol start="6"><li>Poison payload (invalid JSON/schema):</li></ol><ul><li>Risk: listener crash or stuck loop.</li><li>Handling: strict decode + schema validation, count and discard invalid events, continue loop.</li></ul><h3 id="rollout-plan-non-breaking" tabindex="-1">Rollout Plan (Non-Breaking) <a class="header-anchor" href="#rollout-plan-non-breaking" aria-label="Permalink to &quot;Rollout Plan (Non-Breaking)&quot;">​</a></h3><p>Phase 0: Design + observability prep (this track)</p><ul><li>Finalize schema and channel names.</li><li>Add docs for SLOs and required metrics.</li></ul><p>Phase 1: Dark launch behind feature flag</p><ul><li>Add emitter/listener code paths disabled by default.</li><li>Enable only in one non-prod environment.</li><li>Validate no behavior change with flag off.</li></ul><p>Phase 2: Canary</p><ul><li>Enable on 1 node in a multi-node staging cluster.</li><li>Verify cross-node propagation latency and dedupe hit rate.</li><li>Run failover drills (listener reconnect, DB restart).</li></ul><p>Phase 3: Staged production enablement</p><ul><li>Enable for low-risk tenants first.</li><li>Keep reconciliation poll as safety net.</li><li>Roll back by toggling flag off (local path still active).</li></ul><p>Phase 4: Default-on decision</p><ul><li>Require stable error budget over 2 release cycles.</li><li>Promote only after ops sign-off on latency, drift, and invalid-event rates.</li></ul><h3 id="test-plan" tabindex="-1">Test Plan <a class="header-anchor" href="#test-plan" aria-label="Permalink to &quot;Test Plan&quot;">​</a></h3><p>Unit tests:</p><ul><li>Payload encode/decode and schema validation.</li><li>Dedupe cache behavior for duplicate <code>event_id</code>.</li><li>Revision ordering guard (<code>newer</code> wins).</li></ul><p>Integration tests (Postgres-backed):</p><ul><li>Node A emits <code>auth.upsert</code>, Node B receives and enqueues.</li><li>Listener reconnect after forced connection drop.</li><li>Invalid payload does not crash listener loop.</li></ul><p>Resilience tests:</p><ul><li>Burst notifications at &gt; steady-state rate to validate queue pressure behavior.</li><li>Simulated dropped notifications followed by reconciliation repair.</li><li>Postgres restart during active mutation traffic.</li></ul><p>Operational acceptance criteria:</p><ul><li>P95 propagation latency target defined and met in staging.</li><li>No secret/token bytes present in emitted payload logs/metrics.</li><li>Drift detector returns to zero after reconciliation window.</li></ul>`,58)])])}const k=i(o,[["render",n]]);export{u as __pageData,k as default};
