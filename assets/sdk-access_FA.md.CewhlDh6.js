import{_ as i,o as a,c as e,ag as n}from"./chunks/framework.DM0yugQT.js";const E=JSON.parse('{"title":"@sdk/access 开发指引","description":"","frontmatter":{},"headers":[],"relativePath":"sdk-access_FA.md","filePath":"sdk-access_FA.md","lastUpdated":1771822208000}'),t={name:"sdk-access_FA.md"};function h(l,s,k,p,d,r){return a(),e("div",null,[...s[0]||(s[0]=[n(`<h1 id="sdk-access-开发指引" tabindex="-1">@sdk/access 开发指引 <a class="header-anchor" href="#sdk-access-开发指引" aria-label="Permalink to &quot;@sdk/access 开发指引&quot;">​</a></h1><p><code>github.com/router-for-me/CLIProxyAPI/v6/sdk/access</code> 包负责代理的入站访问认证。它提供一个轻量的管理器，用于按顺序链接多种凭证校验实现，让服务器在 CLI 运行时内外都能复用相同的访问控制逻辑。</p><h2 id="引用方式" tabindex="-1">引用方式 <a class="header-anchor" href="#引用方式" aria-label="Permalink to &quot;引用方式&quot;">​</a></h2><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sdkaccess </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">github.com/router-for-me/CLIProxyAPI/v6/sdk/access</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>通过 <code>go get github.com/router-for-me/CLIProxyAPI/v6/sdk/access</code> 添加依赖。</p><h2 id="provider-registry" tabindex="-1">Provider Registry <a class="header-anchor" href="#provider-registry" aria-label="Permalink to &quot;Provider Registry&quot;">​</a></h2><p>访问提供者是全局注册，然后以快照形式挂到 <code>Manager</code> 上：</p><ul><li><code>RegisterProvider(type, provider)</code> 注册一个已经初始化好的 provider 实例。</li><li>每个 <code>type</code> 第一次出现时会记录其注册顺序。</li><li><code>RegisteredProviders()</code> 会按该顺序返回 provider 列表。</li></ul><h2 id="管理器生命周期" tabindex="-1">管理器生命周期 <a class="header-anchor" href="#管理器生命周期" aria-label="Permalink to &quot;管理器生命周期&quot;">​</a></h2><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">manager </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">manager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetProviders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RegisteredProviders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><ul><li><code>NewManager</code> 创建空管理器。</li><li><code>SetProviders</code> 替换提供者切片并做防御性拷贝。</li><li><code>Providers</code> 返回适合并发读取的快照。</li></ul><p>如果管理器本身为 <code>nil</code> 或未配置任何 provider，调用会返回 <code>nil, nil</code>，可视为关闭访问控制。</p><h2 id="认证请求" tabindex="-1">认证请求 <a class="header-anchor" href="#认证请求" aria-label="Permalink to &quot;认证请求&quot;">​</a></h2><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result, authErr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> manager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, req)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> authErr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Authentication succeeded; result carries provider and principal.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsAuthErrorCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authErr, sdkaccess.AuthErrorCodeNoCredentials):</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // No recognizable credentials were supplied.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsAuthErrorCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authErr, sdkaccess.AuthErrorCodeInvalidCredential):</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Credentials were present but rejected.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Provider surfaced a transport-level failure.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>Manager.Authenticate</code> 会按顺序遍历 provider：遇到成功立即返回，<code>AuthErrorCodeNotHandled</code> 会继续尝试下一个；<code>AuthErrorCodeNoCredentials</code> / <code>AuthErrorCodeInvalidCredential</code> 会在遍历结束后汇总给调用方。</p><p><code>Result</code> 提供认证提供者标识、解析出的主体以及可选元数据（例如凭证来源）。</p><h2 id="内建-config-api-key-provider" tabindex="-1">内建 <code>config-api-key</code> Provider <a class="header-anchor" href="#内建-config-api-key-provider" aria-label="Permalink to &quot;内建 \`config-api-key\` Provider&quot;">​</a></h2><p>代理内置一个访问提供者：</p><ul><li><code>config-api-key</code>：校验 <code>config.yaml</code> 顶层的 <code>api-keys</code>。 <ul><li>凭证来源：<code>Authorization: Bearer</code>、<code>X-Goog-Api-Key</code>、<code>X-Api-Key</code>、<code>?key=</code>、<code>?auth_token=</code></li><li>元数据：<code>Result.Metadata[&quot;source&quot;]</code> 会写入匹配到的来源标识</li></ul></li></ul><p>在 CLI 服务端与 <code>sdk/cliproxy</code> 中，该 provider 会根据加载到的配置自动注册。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">api-keys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">sk-test-123</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">sk-prod-456</span></span></code></pre></div><h2 id="引入外部-go-模块提供者" tabindex="-1">引入外部 Go 模块提供者 <a class="header-anchor" href="#引入外部-go-模块提供者" aria-label="Permalink to &quot;引入外部 Go 模块提供者&quot;">​</a></h2><p>若要消费其它 Go 模块输出的访问提供者，直接用空白标识符导入以触发其 <code>init</code> 注册即可：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">github.com/acme/xplatform/sdk/access/providers/partner</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // registers partner-token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sdkaccess </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">github.com/router-for-me/CLIProxyAPI/v6/sdk/access</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>空白导入可确保 <code>init</code> 先执行，从而在你调用 <code>RegisteredProviders()</code>（或 <code>cliproxy.NewBuilder().Build()</code>）之前完成 <code>sdkaccess.RegisterProvider</code>。</p><h3 id="元数据与审计" tabindex="-1">元数据与审计 <a class="header-anchor" href="#元数据与审计" aria-label="Permalink to &quot;元数据与审计&quot;">​</a></h3><p><code>Result.Metadata</code> 用于携带提供者特定的上下文信息。内建的 <code>config-api-key</code> 会记录凭证来源（<code>authorization</code>、<code>x-goog-api-key</code>、<code>x-api-key</code>、<code>query-key</code>、<code>query-auth-token</code>）。自定义提供者同样可以填充该 Map，以便丰富日志与审计场景。</p><h2 id="编写自定义提供者" tabindex="-1">编写自定义提供者 <a class="header-anchor" href="#编写自定义提供者" aria-label="Permalink to &quot;编写自定义提供者&quot;">​</a></h2><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> customProvider</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">customProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Identifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;my-provider&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">customProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sdkaccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sdkaccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AuthError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    token </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.Header.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;X-Custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> token </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewNotHandledError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> token </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;expected&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewInvalidCredentialError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sdkaccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Provider:  p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Identifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Principal: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;service-user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Metadata:  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;source&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;x-custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RegisterProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">customProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>自定义提供者需要实现 <code>Identifier()</code> 与 <code>Authenticate()</code>。在 <code>init</code> 中用已初始化实例调用 <code>RegisterProvider</code> 注册到全局 registry。</p><h2 id="错误语义" tabindex="-1">错误语义 <a class="header-anchor" href="#错误语义" aria-label="Permalink to &quot;错误语义&quot;">​</a></h2><ul><li><code>NewNoCredentialsError()</code>（<code>AuthErrorCodeNoCredentials</code>）：未提供或未识别到凭证。（HTTP 401）</li><li><code>NewInvalidCredentialError()</code>（<code>AuthErrorCodeInvalidCredential</code>）：凭证存在但校验失败。（HTTP 401）</li><li><code>NewNotHandledError()</code>（<code>AuthErrorCodeNotHandled</code>）：告诉管理器跳到下一个 provider。</li><li><code>NewInternalAuthError(message, cause)</code>（<code>AuthErrorCodeInternal</code>）：网络/系统错误。（HTTP 500）</li></ul><p>除可汇总的 <code>not_handled</code> / <code>no_credentials</code> / <code>invalid_credential</code> 外，其它错误会立即冒泡返回。</p><h2 id="与-cliproxy-集成" tabindex="-1">与 cliproxy 集成 <a class="header-anchor" href="#与-cliproxy-集成" aria-label="Permalink to &quot;与 cliproxy 集成&quot;">​</a></h2><p>使用 <code>sdk/cliproxy</code> 构建服务时会自动接入 <code>@sdk/access</code>。如果希望在宿主进程里复用同一个 <code>Manager</code> 实例，可传入自定义管理器：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">coreCfg, _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LoadConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;config.yaml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">accessManager </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">svc, _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cliproxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  WithConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(coreCfg).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  WithConfigPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;config.yaml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  WithRequestAccessManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(accessManager).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>请在调用 <code>Build()</code> 之前完成自定义 provider 的注册（通常通过空白导入触发 <code>init</code>），以确保它们被包含在全局 registry 的快照中。</p><h3 id="动态热更新提供者" tabindex="-1">动态热更新提供者 <a class="header-anchor" href="#动态热更新提供者" aria-label="Permalink to &quot;动态热更新提供者&quot;">​</a></h3><p>当配置发生变化时，刷新依赖配置的 provider，然后重置 manager 的 provider 链：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// configaccess is github.com/router-for-me/CLIProxyAPI/v6/pkg/llmproxy/access/config_access</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">configaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Register</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">newCfg.SDKConfig)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">accessManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetProviders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sdkaccess.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RegisteredProviders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><p>这一流程与 <code>pkg/llmproxy/access.ApplyAccessProviders</code> 保持一致，避免为更新访问策略而重启进程。</p>`,41)])])}const c=i(t,[["render",h]]);export{E as __pageData,c as default};
